@if (loading()) {
  <div class="browse-loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
} @else if (!isAuthenticated()) {
  <div class="browse-login-prompt">
    <div class="prompt-content">
      <fa-icon icon="compass" class="prompt-icon"></fa-icon>
      <h2 jhiTranslate="browse.catalog.title">Explore Disciplines</h2>
      <p jhiTranslate="browse.catalog.loginPrompt">Sign in to browse our full catalog.</p>
      <button class="btn btn-primary btn-lg" (click)="login()" jhiTranslate="browse.catalog.loginButton">Sign In to Explore</button>
    </div>
  </div>
} @else {
  @let l = lesson()!;

  <!-- Compact Top Bar -->
  <div class="lesson-topbar">
    <div class="topbar-left">
      @if (course(); as c) {
        <a [routerLink]="['/catalog/course', c.id]" class="topbar-back">
          <fa-icon icon="chevron-left"></fa-icon>
          <span>{{ c.courseTitle }}</span>
        </a>
      } @else {
        <a routerLink="/catalog" class="topbar-back">
          <fa-icon icon="chevron-left"></fa-icon>
          <span jhiTranslate="browse.catalog.title">Catalog</span>
        </a>
      }
    </div>
    @if (courseLessons().length > 0) {
      <button class="sidebar-toggle" (click)="toggleSidebar()" aria-label="Toggle course contents">
        <fa-icon icon="list-ol"></fa-icon>
      </button>
    }
  </div>

  <!-- Main Layout -->
  <div class="lesson-layout" [class.sidebar-visible]="courseLessons().length > 0">

    <!-- Sidebar -->
    @if (courseLessons().length > 0) {
      <div class="lesson-sidebar-overlay" [class.open]="sidebarOpen()" (click)="toggleSidebar()"></div>
      <aside class="lesson-sidebar" [class.open]="sidebarOpen()">
        <div class="sidebar-header">
          <fa-icon icon="list-ol"></fa-icon>
          <span jhiTranslate="browse.lesson.courseContents">Course Contents</span>
        </div>
        @if (progressPercent() === 100) {
          <div class="sidebar-trophy">
            <fa-icon icon="trophy"></fa-icon>
            <span jhiTranslate="browse.course.courseComplete">Course Complete!</span>
          </div>
        } @else {
          <div class="progress-section">
            <div class="progress-track">
              <div class="progress-fill" [style.width.%]="progressPercent()"></div>
            </div>
            <div class="progress-text">{{ completedLessonIds().size }} / {{ courseLessons().length }}</div>
          </div>
        }
        @if (course(); as c) {
          <a [routerLink]="['/catalog/course', c.id]" class="sidebar-course-title">
            {{ c.courseTitle }}
          </a>
        }
        <div class="sidebar-lesson-list">
          @for (sl of courseLessons(); track sl.id; let i = $index) {
            <button
              class="sidebar-lesson-item"
              [class.active]="isCurrentLesson(sl.id)"
              (click)="navigateToLesson(sl.id)"
            >
              <span class="lesson-check">
                @if (isLessonCompleted(sl.id)) {
                  <fa-icon icon="check-circle" class="completed"></fa-icon>
                } @else {
                  <fa-icon icon="circle" class="incomplete"></fa-icon>
                }
              </span>
              <span class="lesson-number">{{ i + 1 }}</span>
              <span class="lesson-title">{{ sl.lessonTitle }}</span>
              @if (sl.language) {
                <span class="lesson-lang-badge">{{ sl.language }}</span>
              }
            </button>
          }
        </div>
      </aside>
    }

    <!-- Main Content -->
    <main class="lesson-main">

      <!-- Mini Player / Display -->
      <div class="mini-player">
        @if (primaryResource(); as pr) {
          @switch (pr.resourceType) {
            @case ('VIDEO') {
              @if (safeVideoUrl(); as videoUrl) {
                <div class="mini-player-video">
                  <iframe
                    [src]="videoUrl"
                    title="{{ pr.resourceName }}"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                  ></iframe>
                </div>
              } @else {
                <div class="mini-player-card">
                  <div class="card-icon"><fa-icon icon="video"></fa-icon></div>
                  <div class="card-info">
                    <h5>{{ pr.resourceName }}</h5>
                    @if (pr.resourceDescription) { <p>{{ pr.resourceDescription }}</p> }
                  </div>
                  @if (pr.resourceURL) {
                    <a [href]="pr.resourceURL" target="_blank" rel="noopener" class="btn btn-primary">
                      <fa-icon icon="external-link-alt"></fa-icon>
                      <span jhiTranslate="browse.lesson.watchVideo">Watch Video</span>
                    </a>
                  }
                </div>
              }
            }
            @case ('IMAGE') {
              <div class="mini-player-image">
                <img [src]="pr.resourceURL" [alt]="pr.resourceName ?? 'Lesson image'" />
              </div>
            }
            @case ('TUTORIAL') {
              <div class="mini-player-tutorial">
                <div class="tutorial-header">
                  <div class="tutorial-icon"><fa-icon icon="chalkboard-teacher"></fa-icon></div>
                  <div class="tutorial-meta">
                    <span class="tutorial-badge" jhiTranslate="browse.lesson.openTutorial">Interactive Tutorial</span>
                    <h4>{{ pr.resourceName }}</h4>
                  </div>
                </div>
                @if (pr.resourceDescription) {
                  <p class="tutorial-desc">{{ pr.resourceDescription }}</p>
                }
                <div class="tutorial-steps-hint">
                  <fa-icon icon="list-ol"></fa-icon>
                  <span>Follow the step-by-step instructions in the tutorial to build along.</span>
                </div>
                @if (pr.resourceURL) {
                  <a [href]="pr.resourceURL" target="_blank" rel="noopener" class="btn btn-primary btn-launch">
                    <fa-icon icon="external-link-alt"></fa-icon>
                    <span jhiTranslate="browse.lesson.startTutorial">Start Tutorial</span>
                  </a>
                }
              </div>
            }
            @default {
              <div class="mini-player-card">
                <div class="card-icon">
                  @switch (pr.resourceType) {
                    @case ('TOOL') { <fa-icon icon="tools"></fa-icon> }
                    @default { <fa-icon icon="file-alt"></fa-icon> }
                  }
                </div>
                <div class="card-info">
                  <h5>{{ pr.resourceName }}</h5>
                  @if (pr.resourceDescription) { <p>{{ pr.resourceDescription }}</p> }
                  @if (pr.resourceType) { <span class="resource-type-badge">{{ pr.resourceType }}</span> }
                </div>
                @if (pr.resourceURL) {
                  <a [href]="pr.resourceURL" target="_blank" rel="noopener" class="btn btn-primary">
                    <fa-icon icon="external-link-alt"></fa-icon>
                    @if (pr.resourceType === 'TOOL') {
                      <span jhiTranslate="browse.lesson.launchTool">Launch Tool</span>
                    } @else {
                      <span jhiTranslate="browse.lesson.openInNewTab">Open in New Tab</span>
                    }
                  </a>
                }
              </div>
            }
          }
        } @else {
          <div class="mini-player-placeholder">
            <fa-icon icon="video" class="placeholder-icon"></fa-icon>
            <p jhiTranslate="browse.lesson.noContent">No content available for this lesson yet.</p>
          </div>
        }
      </div>

      <!-- Lesson Info -->
      <div class="lesson-info">
        <div class="lesson-title-row">
          <h2>{{ l.lessonTitle }}</h2>
          <button
            class="bookmark-btn"
            [class.bookmarked]="isBookmarked()"
            (click)="toggleBookmark()"
            [title]="isBookmarked() ? ('browse.lesson.removeBookmark' | translate) : ('browse.lesson.bookmark' | translate)"
            aria-label="Bookmark this lesson"
          >
            <fa-icon icon="bookmark"></fa-icon>
          </button>
        </div>
        <div class="lesson-meta">
          @if (l.language) {
            <span class="badge-language">
              <fa-icon icon="globe"></fa-icon>
              {{ l.language }}
            </span>
          }
          @if (courseLessons().length > 0) {
            @let idx = getCurrentLessonIndex();
            @if (idx >= 0) {
              <span class="badge-position">
                {{ idx + 1 }} / {{ courseLessons().length }}
              </span>
            }
          }
          <span class="badge-reading-time">
            <fa-icon icon="clock"></fa-icon>
            <span jhiTranslate="browse.lesson.readingTime" [translateValues]="{ minutes: readingTime() }">{{ readingTime() }} min read</span>
          </span>
          @if (courseLessons().length > 1) {
            <span class="badge-keyboard-hint">
              <fa-icon icon="arrow-left"></fa-icon>
              <fa-icon icon="arrow-right"></fa-icon>
              <span jhiTranslate="browse.lesson.keyboardHint">Arrow keys to navigate</span>
            </span>
          }
        </div>
      </div>

      <!-- Description -->
      @if (l.lessonDescription) {
        <div class="lesson-description">
          <p>{{ l.lessonDescription }}</p>
        </div>
      }

      <!-- My Notes -->
      <div class="lesson-notes">
        <h4 class="notes-title">
          <fa-icon icon="pencil-alt"></fa-icon>
          <span jhiTranslate="browse.lesson.notesTitle">My Notes</span>
        </h4>
        <textarea
          class="form-control notes-textarea"
          rows="4"
          [value]="noteText()"
          (input)="saveNote($any($event.target).value)"
          [placeholder]="'browse.lesson.notesPlaceholder' | translate"
        ></textarea>
        <small class="notes-hint" jhiTranslate="browse.lesson.notesSavedLocally">Notes are saved locally in your browser.</small>
      </div>

      <!-- Lesson Navigation (prev/next) -->
      @if (courseLessons().length > 1) {
        @let idx = getCurrentLessonIndex();
        <div class="lesson-nav">
          @if (idx > 0) {
            <button class="btn btn-outline-secondary lesson-nav-btn" (click)="navigateToLesson(courseLessons()[idx - 1].id)">
              <fa-icon icon="chevron-left"></fa-icon>
              <span jhiTranslate="browse.lesson.previousLesson">Previous Lesson</span>
            </button>
          } @else {
            <div></div>
          }
          @if (idx >= 0 && idx < courseLessons().length - 1) {
            <button class="btn btn-primary lesson-nav-btn" (click)="navigateToLesson(courseLessons()[idx + 1].id)">
              <span jhiTranslate="browse.lesson.nextLesson">Next Lesson</span>
              <fa-icon icon="arrow-right"></fa-icon>
            </button>
          }
        </div>
      }

      <!-- Additional Resources -->
      @if (additionalResources().length > 0) {
        <section class="additional-resources">
          <h4 jhiTranslate="browse.lesson.additionalResources">Additional Resources</h4>
          <div class="resource-list">
            @for (resource of additionalResources(); track resource.id) {
              <div class="resource-item" [class.resource-item-tutorial]="resource.resourceType === 'TUTORIAL'" [class.resource-item-tool]="resource.resourceType === 'TOOL'">
                <div class="resource-icon">
                  @switch (resource.resourceType) {
                    @case ('VIDEO') { <fa-icon icon="video"></fa-icon> }
                    @case ('IMAGE') { <fa-icon icon="image"></fa-icon> }
                    @case ('TOOL') { <fa-icon icon="tools"></fa-icon> }
                    @case ('TUTORIAL') { <fa-icon icon="chalkboard-teacher"></fa-icon> }
                    @default { <fa-icon icon="file-alt"></fa-icon> }
                  }
                </div>
                <div class="resource-info">
                  <h6>{{ resource.resourceName }}</h6>
                  <p>{{ resource.resourceDescription }}</p>
                  @if (resource.resourceType) {
                    <span class="resource-type-badge">{{ resource.resourceType }}</span>
                  }
                </div>
                @if (resource.resourceURL) {
                  <a [href]="resource.resourceURL" target="_blank" rel="noopener"
                    [class]="resource.resourceType === 'TUTORIAL' ? 'btn btn-sm btn-success' : resource.resourceType === 'TOOL' ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-primary'">
                    <fa-icon icon="external-link-alt"></fa-icon>
                    <span [jhiTranslate]="resourceActionLabel(resource.resourceType)">Open</span>
                  </a>
                }
              </div>
            }
          </div>
        </section>
      }
    </main>
  </div>
}
